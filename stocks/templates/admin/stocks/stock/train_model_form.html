{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block extrastyle %}{{ block.super }}
    {# Include form media CSS if any #}
    {{ media.css }}
    <link rel="stylesheet" type="text/css" href="{% static "admin/css/forms.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "admin/css/changelists.css" %}">
    <style>
        /* Custom styles adapted for the train model form */
        .stock-selection-container {
            margin-top: 20px; /* Add margin above stock selection */
        }
        
        .filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
        }
        
        .filter-option {
            display: flex;
            align-items: center;
        }
        
        .filter-option label {
            margin-right: 5px;
            font-weight: bold;
        }
        
        .stock-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #fff;
            width: 100%; /* Make it full width */
            box-sizing: border-box; /* Include padding in width calculation */
        }
        
        .stock-item {
            display: block; /* Changed from flex for checkbox list */
            padding: 5px;
            border-bottom: 1px solid #eee;
            width: 100%; /* Full width for list items */
        }

        /* Style the checkbox list items from the form widget */
        .stock-checkbox-list {
            width: 100%; /* Full width for the list container */
            padding: 0;
            margin: 0;
        }
        .stock-checkbox-list li {
            list-style: none;
            padding: 3px 0;
            width: 100%; /* Full width for each list item */
        }
        .stock-checkbox-list label {
            margin-left: 5px;
            font-weight: normal; /* Override default bold label */
        }
        .stock-checkbox-list .stock-symbol {
            font-weight: bold;
            margin-right: 5px;
        }
        .stock-checkbox-list .stock-name {
            color: #666;
            font-size: 0.9em;
        }
        .stock-checkbox-list .stock-details {
             color: #888;
             font-size: 0.85em;
             margin-left: 20px; /* Indent details */
        }
        
        .select-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        
        .select-actions button {
            padding: 5px 10px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .select-actions button:hover {
            background-color: #e0e0e0;
        }
        
        .date-range-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-start; /* Align items top */
        }
        
        .date-range-container .form-row {
            flex: 1;
            min-width: 200px;
        }
        
        .results-count {
            font-weight: bold;
            margin-top: 10px;
            padding: 5px;
            background-color: #e8f5e9;
            border-radius: 3px;
            text-align: center;
        }
        
        .flex-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        /* Quick actions section */
        .quick-actions {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f1f8e9;
            border: 1px solid #c5e1a5;
            border-radius: 4px;
        }

        .quick-actions h3 {
            margin-top: 0;
            color: #558b2f;
        }

        .quick-action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .quick-action-button {
            padding: 8px 12px;
            background-color: #8bc34a;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }

        .quick-action-button:hover {
            background-color: #7cb342;
        }

        .subtitle {
            font-size: 16px;
            color: #555;
            margin-bottom: 20px;
        }
    </style>
{% endblock %}

{% block extrahead %}{{ block.super }}
    {# Include form media JS if any (for date picker etc.) #}
    {{ media.js }}
    <script src="{% url 'admin:jsi18n' %}"></script> {# Required for admin date widget #}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Stock Filtering and Selection ---
            const stockListContainer = document.querySelector('.stock-checkbox-list'); // Target the ul generated by the widget
            const stockItems = stockListContainer ? stockListContainer.querySelectorAll('li') : [];

            // Function to filter stocks based on sector and industry selectors
            function filterStocks() {
                const sectorFilter = document.getElementById('sector-filter').value;
                const industryFilter = document.getElementById('industry-filter').value;
                const searchFilter = document.getElementById('search-filter').value.toLowerCase();
                let visibleCount = 0;
                
                stockItems.forEach(function(item) {
                    const label = item.querySelector('label');
                    if (!label) return; // Skip if no label found

                    const sector = label.getAttribute('data-sector') || '';
                    const industry = label.getAttribute('data-industry') || '';
                    const symbol = (label.querySelector('.stock-symbol')?.innerText || '').toLowerCase();
                    const name = (label.querySelector('.stock-name')?.innerText || '').toLowerCase();
                    
                    const matchesSector = sectorFilter === '' || sector === sectorFilter;
                    const matchesIndustry = industryFilter === '' || industry === industryFilter;
                    const matchesSearch = searchFilter === '' || 
                                         symbol.includes(searchFilter) || 
                                         name.includes(searchFilter);
                    
                    if (matchesSector && matchesIndustry && matchesSearch) {
                        item.style.display = '';
                        visibleCount++;
                    } else {
                        item.style.display = 'none';
                    }
                });
                
                // Update visible count
                document.getElementById('visible-count').innerText = visibleCount;
                document.getElementById('total-count').innerText = stockItems.length;
            }
            
            // Attach event listeners to filters
            document.getElementById('sector-filter')?.addEventListener('change', filterStocks);
            document.getElementById('industry-filter')?.addEventListener('change', filterStocks);
            document.getElementById('search-filter')?.addEventListener('input', filterStocks);
            
            // Select/Deselect all visible stocks
            document.getElementById('select-all-visible')?.addEventListener('click', function() {
                const visibleItems = stockListContainer ? stockListContainer.querySelectorAll('li:not([style*="display: none"]) input[type="checkbox"]') : [];
                visibleItems.forEach(checkbox => checkbox.checked = true);
                updateSelectedCount();
            });
            
            document.getElementById('deselect-all')?.addEventListener('click', function() {
                const checkboxes = stockListContainer ? stockListContainer.querySelectorAll('input[type="checkbox"]') : [];
                checkboxes.forEach(checkbox => checkbox.checked = false);
                updateSelectedCount();
            });

            // Quick actions for stock selection
            document.getElementById('select-tech')?.addEventListener('click', function() {
                document.getElementById('sector-filter').value = 'Technology';
                filterStocks();
                document.getElementById('select-all-visible').click();
            });
            
            document.getElementById('select-finance')?.addEventListener('click', function() {
                document.getElementById('sector-filter').value = 'Financial Services';
                filterStocks();
                document.getElementById('select-all-visible').click();
            });
            
            document.getElementById('select-healthcare')?.addEventListener('click', function() {
                document.getElementById('sector-filter').value = 'Healthcare';
                filterStocks();
                document.getElementById('select-all-visible').click();
            });
            
            document.getElementById('select-top-50')?.addEventListener('click', function() {
                const limit = Math.min(50, stockItems.length);
                
                // First uncheck all
                stockItems.forEach(item => {
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    if (checkbox) checkbox.checked = false;
                });
                
                // Then check the first 50 visible (or just first 50 overall if filtering is complex)
                let count = 0;
                stockItems.forEach(item => {
                    if (count < limit) {
                         const checkbox = item.querySelector('input[type="checkbox"]');
                         if (checkbox) {
                             checkbox.checked = true;
                             count++;
                         }
                    }
                });
                
                updateSelectedCount();
            });
            
            // Function to update the selected count
            function updateSelectedCount() {
                const selectedCount = stockListContainer ? stockListContainer.querySelectorAll('input[type="checkbox"]:checked').length : 0;
                document.getElementById('selected-count').innerText = selectedCount;
            }
            
            // Add change event to all checkboxes
            stockItems.forEach(function(item) {
                const checkbox = item.querySelector('input[type="checkbox"]');
                checkbox?.addEventListener('change', updateSelectedCount);
            });
            
            // Initialize filters and counts if elements exist
            if (document.getElementById('sector-filter')) {
                 filterStocks();
                 updateSelectedCount();
            }

            // --- Date Quick Selection ---
            document.getElementById('last-year')?.addEventListener('click', function() {
                const today = new Date();
                const lastYear = new Date();
                lastYear.setDate(today.getDate() - 365);
                
                document.getElementById('id_start_date').value = formatDate(lastYear);
                document.getElementById('id_end_date').value = formatDate(today);
            });
            
            document.getElementById('last-3-years')?.addEventListener('click', function() {
                const today = new Date();
                const last3Years = new Date();
                last3Years.setDate(today.getDate() - (3 * 365));
                
                document.getElementById('id_start_date').value = formatDate(last3Years);
                document.getElementById('id_end_date').value = formatDate(today);
            });
            
            document.getElementById('last-5-years')?.addEventListener('click', function() {
                const today = new Date();
                const last5Years = new Date();
                last5Years.setDate(today.getDate() - (5 * 365));
                
                document.getElementById('id_start_date').value = formatDate(last5Years);
                document.getElementById('id_end_date').value = formatDate(today);
            });
            
            function formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // --- Enhance Stock Checkbox Labels ---
            // Add data attributes and extra info to labels for filtering
            stockItems.forEach(function(item) {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const label = item.querySelector('label');
                if (checkbox && label) {
                    const stockId = checkbox.value;
                    // Find the corresponding stock data (this assumes all_stocks is available in JS, which isn't ideal)
                    // A better approach would be to embed data attributes in the template directly
                    // For now, we'll just use the label text if possible
                    const labelText = label.innerText;
                    // Attempt to parse symbol/name (this is fragile)
                    const symbolMatch = labelText.match(/^([A-Z]+(?:\.[A-Z]+)?)/); // Basic symbol match
                    const symbol = symbolMatch ? symbolMatch[1] : '';
                    // Find the hidden data attributes added in the template loop below
                    const sector = label.getAttribute('data-sector') || '';
                    const industry = label.getAttribute('data-industry') || '';
                    const name = label.getAttribute('data-name') || '';

                    // Reconstruct label content with classes for styling/selection
                    label.innerHTML = `
                        <span class="stock-symbol">${symbol}</span>
                        <span class="stock-name">${name}</span>
                        <div class="stock-details">
                            ${sector ? `Sector: ${sector}` : ''}
                            ${sector && industry ? ' | ' : ''}
                            ${industry ? `Industry: ${industry}` : ''}
                        </div>
                    `;
                }
            });
            // Re-run initial filter after enhancing labels
             if (document.getElementById('sector-filter')) {
                 filterStocks();
             }
        });
    </script>
{% endblock %}

{% block coltype %}colM{% endblock %}

{% block bodyclass %}{{ block.super }} app-{{ opts.app_label }} model-{{ opts.model_name }} change-form{% endblock %}

{% if not is_popup %}
{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% translate 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
&rsaquo; <a href="{% url 'admin:stocks_stock_changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a>
&rsaquo; {% translate 'Train Models' %}
</div>
{% endblock %}
{% endif %}

{% block content %}
<div id="content-main">
    <form method="post" id="train-model-form">
        {% csrf_token %}
        
        <h1>{{ title }}</h1>
        
        {% if subtitle %}
        <p class="subtitle">{{ subtitle }}</p>
        {% endif %}

        {% if form.non_field_errors %}
            <p class="errornote">
            {% if form.non_field_errors.count == 1 %}{% translate "Please correct the error below." %}{% else %}{% translate "Please correct the errors below." %}{% endif %}
            </p>
            {{ form.non_field_errors }}
        {% endif %}

        <!-- Model Configuration -->
        <fieldset class="module aligned">
            <h2>Model Configuration</h2>
            <div class="form-row field-{{ form.model_type.name }}">
                {{ form.model_type.errors }}
                <div class="flex-container">
                     <label class="required" for="{{ form.model_type.id_for_label }}">{{ form.model_type.label }}:</label>
                     {{ form.model_type }}
                </div>
                {% if form.model_type.help_text %}
                    <div class="help">{{ form.model_type.help_text|safe }}</div>
                {% endif %}
            </div>
        </fieldset>

        <!-- Training Data Selection -->
        <fieldset class="module aligned">
            <h2>Training Data Range</h2>
             <!-- Quick Actions for Date Selection -->
            <div class="quick-actions" style="margin-top: 10px; margin-bottom: 10px; background-color: #e3f2fd;">
                <h3 style="color: #1565c0;">Quick Date Selection</h3>
                <div class="quick-action-buttons">
                    <button type="button" id="last-year" class="quick-action-button" style="background-color: #64b5f6;">Last Year</button>
                    <button type="button" id="last-3-years" class="quick-action-button" style="background-color: #42a5f5;">Last 3 Years</button>
                    <button type="button" id="last-5-years" class="quick-action-button" style="background-color: #2196f3;">Last 5 Years</button>
                </div>
            </div>
            <div class="date-range-container">
                <div class="form-row field-{{ form.start_date.name }}">
                    {{ form.start_date.errors }}
                    <div class="flex-container">
                         <label class="required" for="{{ form.start_date.id_for_label }}">{{ form.start_date.label }}:</label>
                         {{ form.start_date }}
                    </div>
                    {% if form.start_date.help_text %}
                        <div class="help">{{ form.start_date.help_text|safe }}</div>
                    {% endif %}
                </div>
                <div class="form-row field-{{ form.end_date.name }}">
                    {{ form.end_date.errors }}
                    <div class="flex-container">
                         <label class="required" for="{{ form.end_date.id_for_label }}">{{ form.end_date.label }}:</label>
                         {{ form.end_date }}
                    </div>
                    {% if form.end_date.help_text %}
                        <div class="help">{{ form.end_date.help_text|safe }}</div>
                    {% endif %}
                </div>
            </div>
        </fieldset>

        <!-- Hyperparameters -->
        <fieldset class="module aligned">
            <h2>Hyperparameters</h2>
             <div class="form-row field-{{ form.epochs.name }}">
                {{ form.epochs.errors }}
                <div class="flex-container">
                     <label class="required" for="{{ form.epochs.id_for_label }}">{{ form.epochs.label }}:</label>
                     {{ form.epochs }}
                </div>
                {% if form.epochs.help_text %}
                    <div class="help">{{ form.epochs.help_text|safe }}</div>
                {% endif %}
            </div>
             <div class="form-row field-{{ form.batch_size.name }}">
                {{ form.batch_size.errors }}
                <div class="flex-container">
                     <label class="required" for="{{ form.batch_size.id_for_label }}">{{ form.batch_size.label }}:</label>
                     {{ form.batch_size }}
                </div>
                {% if form.batch_size.help_text %}
                    <div class="help">{{ form.batch_size.help_text|safe }}</div>
                {% endif %}
            </div>
            {# Add more hyperparameter fields here if needed #}
        </fieldset>
        
        <!-- Stock Selection -->
        <fieldset class="module aligned stock-selection-container">
            <h2>Select Stocks</h2>
            
             <!-- Quick Actions for Stock Selection -->
            <div class="quick-actions" style="background-color: #e8f5e9;">
                <h3 style="color: #388e3c;">Quick Stock Selection</h3>
                <div class="quick-action-buttons">
                    <button type="button" id="select-tech" class="quick-action-button">All Technology</button>
                    <button type="button" id="select-finance" class="quick-action-button">All Financial</button>
                    <button type="button" id="select-healthcare" class="quick-action-button">All Healthcare</button>
                    <button type="button" id="select-top-50" class="quick-action-button">Top 50 Stocks</button>
                </div>
            </div>

            <div class="filter-options">
                <div class="filter-option">
                    <label for="search-filter">Search:</label>
                    <input type="text" id="search-filter" placeholder="Symbol or name...">
                </div>
                <div class="filter-option">
                    <label for="sector-filter">Sector:</label>
                    <select id="sector-filter">
                        <option value="">All Sectors</option>
                        {% for sector in sectors %}
                            <option value="{{ sector }}">{{ sector }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-option">
                    <label for="industry-filter">Industry:</label>
                    <select id="industry-filter">
                        <option value="">All Industries</option>
                        {% for industry in industries %}
                            <option value="{{ industry }}">{{ industry }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="results-count">
                Showing <span id="visible-count">0</span> of <span id="total-count">0</span> stocks 
                (<span id="selected-count">0</span> selected)
            </div>
            
            <div class="select-actions">
                <button type="button" id="select-all-visible">Select All Visible</button>
                <button type="button" id="deselect-all">Deselect All</button>
            </div>
            
            <div class="form-row field-{{ form.stocks.name }}">
                 {{ form.stocks.errors }}
                 <div class="stock-list">
                    {# Render the checkbox select multiple widget #}
                    {# We need to manually add data attributes to the labels for filtering #}
                    {% for choice in form.stocks %}
                        <li class="stock-item">
                            <input type="checkbox" name="{{ form.stocks.name }}" value="{{ choice.choice_value }}" id="id_{{ form.stocks.name }}_{{ forloop.counter0 }}" {% if choice.choice_value in form.stocks.value %}checked{% endif %}>
                            <label for="id_{{ form.stocks.name }}_{{ forloop.counter0 }}"
                                   data-sector="{{ choice.instance.sector|default:'' }}"
                                   data-industry="{{ choice.instance.industry|default:'' }}"
                                   data-name="{{ choice.instance.name|default:'' }}">
                                   {# JS will populate the content of this label #}
                                   {{ choice.choice_label }} {# Initial label from form field #}
                            </label>
                        </li>
                    {% endfor %}
                 </div>
                 {% if form.stocks.help_text %}
                    <div class="help">{{ form.stocks.help_text|safe }}</div>
                 {% endif %}
            </div>
        </fieldset>

        <div class="submit-row">
            <input type="submit" name="start_training" value="Start Training" class="default">
        </div>
    </form>
</div>
{% endblock %}
