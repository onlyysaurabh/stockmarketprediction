{% extends "admin/base.html" %}
{% load i18n admin_urls static dict_filters jazzmin %}
{% get_jazzmin_ui_tweaks as jazzmin_ui %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" type="text/css" href="{% static "admin/css/forms.css" %}">
  <link rel="stylesheet" href="{% static 'admin/css/widgets.css' %}">
  <style>
    .model-card {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 10px;
        background-color: #f9f9f9;
    }
    .model-card h3 {
        margin-top: 0;
    }
    .model-stats {
        display: flex;
        justify-content: space-around;
        margin-bottom: 1rem;
    }
    .stat-box {
        text-align: center;
        padding: 10px;
        border-radius: 4px;
        background-color: #e9ecef;
        min-width: 150px;
    }
    .stat-box h4 {
        margin: 0;
        font-size: 24px;
    }
    .stat-box p {
        margin: 5px 0 0;
        color: #666;
    }
    
    .model-table {
        width: 100%;
        border-collapse: collapse;
    }
    .model-table th, .model-table td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    .model-table tr:hover {
        background-color: #f5f5f5;
    }
    
    /* Tabs styling */
    .nav-tabs {
        border-bottom: 1px solid #ddd;
        display: flex;
        list-style: none;
        padding-left: 0;
        margin-bottom: 15px;
    }
    .nav-tabs li {
        margin-bottom: -1px;
    }
    .nav-tabs a {
        display: block;
        padding: 10px 15px;
        border: 1px solid transparent;
        border-radius: 4px 4px 0 0;
        text-decoration: none;
    }
    .nav-tabs .active a {
        border-color: #ddd #ddd #fff;
        background-color: #fff;
    }
    
    .tab-content > .tab-pane {
        display: none;
    }
    .tab-content > .active {
        display: block;
    }

    /* Date range quick selection buttons */
    .date-preset-buttons {
        display: flex;
        gap: 10px;
        margin: 10px 0;
    }
    
    .date-preset-button {
        padding: 5px 10px;
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .date-preset-button:hover {
        background-color: #e9ecef;
    }
  </style>
{% endblock %}

{% block extrahead %}
  {{ block.super }}
  <script type="text/javascript" src="{% static 'admin/js/vendor/jquery/jquery.min.js' %}"></script>
  <script type="text/javascript">
    $(document).ready(function() {
        // Tab functionality
        $('.nav-tabs a').click(function(e) {
            e.preventDefault();
            $(this).tab('show');
        });

        $('.nav-tabs a').on('shown.bs.tab', function(e) {
            // Store the active tab
            localStorage.setItem('activeTab', $(e.target).attr('href'));
        });

        // Set the active tab based on localStorage
        var activeTab = localStorage.getItem('activeTab');
        if(activeTab){
            $('.nav-tabs a[href="' + activeTab + '"]').tab('show');
        } else {
            $('.nav-tabs a:first').tab('show');
        }
        
        // Date preset buttons functionality
        $('.date-preset-button').click(function() {
            var period = $(this).data('period');
            var today = new Date();
            var startDate = new Date();
            
            // Set the start date based on the selected period
            if (period === 'month') {
                startDate.setMonth(today.getMonth() - 1);
            } else if (period === 'year') {
                startDate.setFullYear(today.getFullYear() - 1);
            } else if (period === 'five_years') {
                startDate.setFullYear(today.getFullYear() - 5);
            }
            
            // Format dates as YYYY-MM-DD for input fields
            var formatDate = function(date) {
                var month = '' + (date.getMonth() + 1),
                    day = '' + date.getDate(),
                    year = date.getFullYear();
                
                if (month.length < 2) month = '0' + month;
                if (day.length < 2) day = '0' + day;
                
                return [year, month, day].join('-');
            };
            
            // Set the input field values
            $('#id_start_date').val(formatDate(startDate));
            $('#id_end_date').val(formatDate(today));
        });
    });
    
    $.fn.tab = function(action) {
        if (action === 'show') {
            var $this = $(this);
            var $target = $($this.attr('href'));
            
            // Remove active class from all tabs and tab panes
            $('.nav-tabs li').removeClass('active');
            $('.tab-content > .tab-pane').removeClass('active');
            
            // Add active class to the current tab and tab pane
            $this.parent().addClass('active');
            $target.addClass('active');
        }
    };
  </script>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:app_list' app_label='stocks' %}">Stocks</a>
&rsaquo; {% trans 'Prediction Model Management' %}
</div>
{% endblock %}

{% block content %}
<div id="content-main">
    <h1>Prediction Model Management</h1>
    
    <div class="model-stats">
        {% for model_type, count in model_counts.items %}
        <div class="stat-box">
            <h4>{{ count }}</h4>
            <p>{{ model_type }} Models</p>
        </div>
        {% endfor %}
        <div class="stat-box">
            <h4>{{ trained_models.count }}</h4>
            <p>Total Models</p>
        </div>
    </div>
    
    <div class="model-card">
        <h2>Train New Model</h2>
        <form method="post" action="{% url 'admin_train_model' %}">
            {% csrf_token %}
            <div class="form-row">
                <div class="fieldWrapper">
                    <label for="id_stock_symbol">Stock Symbol:</label>
                    <select name="stock_symbol" id="id_stock_symbol" required>
                        <option value="">---------</option>
                        {% for stock in stocks %}
                        <option value="{{ stock.symbol }}">{{ stock.symbol }} - {{ stock.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="fieldWrapper">
                    <label for="id_model_type">Model Type:</label>
                    <select name="model_type" id="id_model_type" required>
                        <option value="">---------</option>
                        {% for model_type, model_name in model_choices %}
                        <option value="{{ model_type }}">{{ model_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="fieldWrapper">
                    <label>Date Range:</label>
                    <div class="date-preset-buttons">
                        <button type="button" class="date-preset-button" data-period="month">Last Month</button>
                        <button type="button" class="date-preset-button" data-period="year">Last Year</button>
                        <button type="button" class="date-preset-button" data-period="five_years">Last 5 Years</button>
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="fieldWrapper">
                    <label for="id_start_date">Start Date:</label>
                    <input type="date" name="start_date" id="id_start_date" value="{{ date_presets.year.start_date|date:'Y-m-d' }}" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="fieldWrapper">
                    <label for="id_end_date">End Date:</label>
                    <input type="date" name="end_date" id="id_end_date" value="{{ date_presets.year.end_date|date:'Y-m-d' }}" required>
                </div>
            </div>
            
            <div class="submit-row">
                <input type="submit" value="Train Model" class="default" name="_save">
            </div>
        </form>
    </div>

    <ul class="nav-tabs">
        <li><a href="#recent-models">Recent Models</a></li>
        <li><a href="#stock-predictions">Stock Predictions</a></li>
    </ul>
    
    <div class="tab-content">
        <div class="tab-pane" id="recent-models">
            <h2>Recent Trained Models</h2>
            {% if trained_models %}
            <table class="model-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Stock</th>
                        <th>Model Type</th>
                        <th>Trained At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for model in trained_models %}
                    <tr>
                        <td>{{ model.id }}</td>
                        <td>{{ model.stock.symbol }}</td>
                        <td>{{ model.get_model_type_display }}</td>
                        <td>{{ model.trained_at }}</td>
                        <td>
                            <a href="{% url 'admin_model_detail' model.id %}" class="button">View Details</a>
                            <form style="display: inline-block;" method="post" action="{% url 'admin_delete_model' model.id %}">
                                {% csrf_token %}
                                <button type="submit" onclick="return confirm('Are you sure you want to delete this model?')" class="button">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>No models have been trained yet.</p>
            {% endif %}
        </div>
        
        <div class="tab-pane" id="stock-predictions">
            <h2>Stock Predictions</h2>
            
            <table class="model-table">
                <thead>
                    <tr>
                        <th>Stock</th>
                        <th>Latest Model</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stock in stocks %}
                    <tr>
                        <td>{{ stock.symbol }} - {{ stock.name }}</td>
                        <td>
                            {% if stock.symbol in recent_models %}
                                {{ recent_models|get_item:stock.symbol|get_item:"get_model_type_display" }} trained on 
                                {{ recent_models|get_item:stock.symbol|get_item:"trained_at" }}
                            {% else %}
                                No models trained
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'admin_stock_predictions' stock.id %}" class="button">View Predictions</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}