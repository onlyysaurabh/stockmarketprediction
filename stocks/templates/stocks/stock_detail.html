{% extends 'stocks/base.html' %}
{% load tz %} {# Load timezone filters/tags #}
{% load humanize %} {# Load humanize filters for better number formatting #}
{% load stock_tags %} {# Load our custom tags (including get_item) #}

{% block title %}{{ stock_data.symbol }} - Stock Details{% endblock %}

{% block content %}
    <h1>{{ stock_data.name|default:stock_data.symbol }} ({{ stock_data.symbol }})</h1>

    <div class="action-buttons">
        {# Update Button Form #}
        <form method="POST" action="{% url 'update_stock_data' symbol=stock_data.symbol %}" class="update-form">
            {% csrf_token %}
            <button type="submit" class="btn btn-update">
                <i class="fas fa-sync-alt"></i> Update Data
            </button>
        </form>

        {% if user.is_authenticated %}
            <a href="{% url 'add_to_watchlist_with_symbol' symbol=stock_data.symbol %}" class="btn btn-watchlist">
                <i class="fas fa-star"></i> Add to Watchlist
            </a>
        {% endif %}
    </div>

    {% if stock_data.last_updated %}
        <div class="last-updated-info">
            <i class="fas fa-clock"></i> Last Updated:
            {% timezone "Asia/Calcutta" %}
            {{ stock_data.last_updated|date:"Y-m-d H:i:s T" }}
            {% endtimezone %}
        </div>
    {% endif %}

    {# Chart Section - Keep at the top #}
    <h2>Historical Price Chart</h2>

    {# Duration Selection Buttons #}
    <div style="margin-bottom: 10px;" class="duration-selector">
        <button data-period="1m" class="active">1M</button> {# Default active #}
        <button data-period="6m">6M</button>
        <button data-period="1y">1Y</button>
        <button data-period="5y">5Y</button>
        <button data-period="max">Max</button>
    </div>

    {# Data Series Toggles #}
    <div style="margin-bottom: 15px;" class="series-toggles">
        <label><input type="checkbox" class="chart-toggle" data-dataset-index="0" checked> Close</label>
        <label><input type="checkbox" class="chart-toggle" data-dataset-index="1"> Open</label>
        <label><input type="checkbox" class="chart-toggle" data-dataset-index="2"> High</label>
        <label><input type="checkbox" class="chart-toggle" data-dataset-index="3"> Low</label>
        <label><input type="checkbox" class="chart-toggle" data-dataset-index="4"> Volume</label>
        {# Add Commodity Toggles #}
        <label style="margin-left: 20px; border-left: 1px solid #ccc; padding-left: 15px;"><input type="checkbox" class="commodity-toggle" data-commodity="Gold"> Gold</label>
        <label><input type="checkbox" class="commodity-toggle" data-commodity="Crude Oil"> Oil</label>
        <label><input type="checkbox" class="commodity-toggle" data-commodity="Bitcoin"> Bitcoin</label>
    </div>
    <div style="max-width: 100%; height: 500px;"> {# Increased height for better visibility #}
        <canvas id="stockChart"></canvas>
    </div>

    <hr style="margin: 30px 0;">

    {# Predictions Section #}
    {% if model_predictions.models_available %}
    <h2>Price Predictions</h2>
    <div class="predictions-panel">

        <div class="prediction-grid">
            <!-- First row: ARIMA and LSTM -->
            <div class="prediction-row">

                {# ARIMA Section #}
                {% with model_type="arima" %}
                {% with next_day_pred=model_predictions.predictions.next_day|get_item:model_type %}
                {% if next_day_pred is not None %} {# Check if prediction exists for this model #}
                    <div class="prediction-model-section">
                        <h3 class="model-name">ARIMA</h3>
                        {% with current_price=stock_info.currentPrice|default:stock_info.regularMarketPrice|default:stock_info.regularMarketPreviousClose|default:stock_historical_data.0.Close|default:206.37 %}
                        <div class="prediction-cards">
                            {# Next Day #}
                            <div class="prediction-card">
                                <div class="prediction-time">Next Day</div>
                                <div class="prediction-date">{{ model_predictions.prediction_dates.next_day }}</div>
                                <div class="prediction-price">${{ next_day_pred|floatformat:2 }}</div>
                                {% with raw_change=next_day_pred|subtract:current_price %}
                                <div class="prediction-change {% if raw_change > 0 %}positive{% elif raw_change < 0 %}negative{% else %}neutral{% endif %}">
                                    {% if raw_change > 0 %}+{% endif %}${{ raw_change|floatformat:2 }} ({% if raw_change > 0 %}+{% endif %}{{ raw_change|multiply:100|divide:current_price|floatformat:2 }}%)
                                </div>
                                {% endwith %}
                            </div>
                            {# Next Week #}
                            {% with next_week_pred=model_predictions.predictions.next_week|get_item:model_type %}
                            {% if next_week_pred is not None %}
                            <div class="prediction-card">
                                <div class="prediction-time">Next Week</div>
                                <div class="prediction-date">{{ model_predictions.prediction_dates.next_week }}</div>
                                <div class="prediction-price">${{ next_week_pred|floatformat:2 }}</div>
                                {% with raw_change=next_week_pred|subtract:current_price %}
                                <div class="prediction-change {% if raw_change > 0 %}positive{% elif raw_change < 0 %}negative{% else %}neutral{% endif %}">
                                    {% if raw_change > 0 %}+{% endif %}${{ raw_change|floatformat:2 }} ({% if raw_change > 0 %}+{% endif %}{{ raw_change|multiply:100|divide:current_price|floatformat:2 }}%)
                                </div>
                                {% endwith %}
                            </div>
                            {% endif %}
                            {% endwith %}
                            {# Next Month #}
                            {% with next_month_pred=model_predictions.predictions.next_month|get_item:model_type %}
                            {% if next_month_pred is not None %}
                            <div class="prediction-card">
                                <div class="prediction-time">Next Month</div>
                                <div class="prediction-date">{{ model_predictions.prediction_dates.next_month }}</div>
                                <div class="prediction-price">${{ next_month_pred|floatformat:2 }}</div>
                                {% with raw_change=next_month_pred|subtract:current_price %}
                                <div class="prediction-change {% if raw_change > 0 %}positive{% elif raw_change < 0 %}negative{% else %}neutral{% endif %}">
                                    {% if raw_change > 0 %}+{% endif %}${{ raw_change|floatformat:2 }} ({% if raw_change > 0 %}+{% endif %}{{ raw_change|multiply:100|divide:current_price|floatformat:2 }}%)
                                </div>
                                {% endwith %}
                            </div>
                            {% endif %}
                            {% endwith %}
                        </div>
                        {% endwith %} {# end with current_price #}
                    </div>
                {% endif %} {# end check if prediction exists #}
                {% endwith %} {# end with next_day_pred #}
                {% endwith %} {# end with model_type #}

                {# LSTM Section #}
                {% with model_type="lstm" %}
                {% with next_day_pred=model_predictions.predictions.next_day|get_item:model_type %}
                {% if next_day_pred is not None %} {# Check if prediction exists for this model #}
                    <div class="prediction-model-section">
                        <h3 class="model-name">LSTM</h3>
                        {% with current_price=stock_info.currentPrice|default:stock_info.regularMarketPrice|default:stock_info.regularMarketPreviousClose|default:stock_historical_data.0.Close|default:206.37 %}
                        <div class="prediction-cards">
                             {# Next Day #}
                            <div class="prediction-card">
                                <div class="prediction-time">Next Day</div>
                                <div class="prediction-date">{{ model_predictions.prediction_dates.next_day }}</div>
                                <div class="prediction-price">${{ next_day_pred|floatformat:2 }}</div>
                                {% with raw_change=next_day_pred|subtract:current_price %}
                                <div class="prediction-change {% if raw_change > 0 %}positive{% elif raw_change < 0 %}negative{% else %}neutral{% endif %}">
                                    {% if raw_change > 0 %}+{% endif %}${{ raw_change|floatformat:2 }} ({% if raw_change > 0 %}+{% endif %}{{ raw_change|multiply:100|divide:current_price|floatformat:2 }}%)
                                </div>
                                {% endwith %}
                            </div>
                             {# Next Week #}
                            {% with next_week_pred=model_predictions.predictions.next_week|get_item:model_type %}
                            {% if next_week_pred is not None %}
                            <div class="prediction-card">
                                <div class="prediction-time">Next Week</div>
                                <div class="prediction-date">{{ model_predictions.prediction_dates.next_week }}</div>
                                <div class="prediction-price">${{ next_week_pred|floatformat:2 }}</div>
                                {% with raw_change=next_week_pred|subtract:current_price %}
                                <div class="prediction-change {% if raw_change > 0 %}positive{% elif raw_change < 0 %}negative{% else %}neutral{% endif %}">
                                    {% if raw_change > 0 %}+{% endif %}${{ raw_change|floatformat:2 }} ({% if raw_change > 0 %}+{% endif %}{{ raw_change|multiply:100|divide:current_price|floatformat:2 }}%)
                                </div>
                                {% endwith %}
                            </div>
                            {% endif %}
                            {% endwith %}
                             {# Next Month #}
                            {% with next_month_pred=model_predictions.predictions.next_month|get_item:model_type %}
                            {% if next_month_pred is not None %}
                            <div class="prediction-card">
                                <div class="prediction-time">Next Month</div>
                                <div class="prediction-date">{{ model_predictions.prediction_dates.next_month }}</div>
                                <div class="prediction-price">${{ next_month_pred|floatformat:2 }}</div>
                                {% with raw_change=next_month_pred|subtract:current_price %}
                                <div class="prediction-change {% if raw_change > 0 %}positive{% elif raw_change < 0 %}negative{% else %}neutral{% endif %}">
                                    {% if raw_change > 0 %}+{% endif %}${{ raw_change|floatformat:2 }} ({% if raw_change > 0 %}+{% endif %}{{ raw_change|multiply:100|divide:current_price|floatformat:2 }}%)
                                </div>
                                {% endwith %}
                            </div>
                            {% endif %}
                            {% endwith %}
                        </div>
                        {% endwith %} {# end with current_price #}
                    </div>
                {% endif %} {# end check if prediction exists #}
                {% endwith %} {# end with next_day_pred #}
                {% endwith %} {# end with model_type #}

            </div> {# End First Row #}

            <!-- Second row: SVM and XGBoost -->
            <div class="prediction-row">

                {# SVM Section #}
                {% with model_type="svm" %}
                {% with next_day_pred=model_predictions.predictions.next_day|get_item:model_type %}
                {% if next_day_pred is not None %} {# Check if prediction exists for this model #}
                    <div class="prediction-model-section">
                        <h3 class="model-name">SVM</h3>
                        {% with current_price=stock_info.currentPrice|default:stock_info.regularMarketPrice|default:stock_info.regularMarketPreviousClose|default:stock_historical_data.0.Close|default:206.37 %}
                        <div class="prediction-cards">
                             {# Next Day #}
                            <div class="prediction-card">
                                <div class="prediction-time">Next Day</div>
                                <div class="prediction-date">{{ model_predictions.prediction_dates.next_day }}</div>
                                <div class="prediction-price">${{ next_day_pred|floatformat:2 }}</div>
                                {% with raw_change=next_day_pred|subtract:current_price %}
                                <div class="prediction-change {% if raw_change > 0 %}positive{% elif raw_change < 0 %}negative{% else %}neutral{% endif %}">
                                    {% if raw_change > 0 %}+{% endif %}${{ raw_change|floatformat:2 }} ({% if raw_change > 0 %}+{% endif %}{{ raw_change|multiply:100|divide:current_price|floatformat:2 }}%)
                                </div>
                                {% endwith %}
                            </div>
                             {# Next Week #}
                            {% with next_week_pred=model_predictions.predictions.next_week|get_item:model_type %}
                            {% if next_week_pred is not None %}
                            <div class="prediction-card">
                                <div class="prediction-time">Next Week</div>
                                <div class="prediction-date">{{ model_predictions.prediction_dates.next_week }}</div>
                                <div class="prediction-price">${{ next_week_pred|floatformat:2 }}</div>
                                {% with raw_change=next_week_pred|subtract:current_price %}
                                <div class="prediction-change {% if raw_change > 0 %}positive{% elif raw_change < 0 %}negative{% else %}neutral{% endif %}">
                                    {% if raw_change > 0 %}+{% endif %}${{ raw_change|floatformat:2 }} ({% if raw_change > 0 %}+{% endif %}{{ raw_change|multiply:100|divide:current_price|floatformat:2 }}%)
                                </div>
                                {% endwith %}
                            </div>
                            {% endif %}
                            {% endwith %}
                             {# Next Month #}
                            {% with next_month_pred=model_predictions.predictions.next_month|get_item:model_type %}
                            {% if next_month_pred is not None %}
                            <div class="prediction-card">
                                <div class="prediction-time">Next Month</div>
                                <div class="prediction-date">{{ model_predictions.prediction_dates.next_month }}</div>
                                <div class="prediction-price">${{ next_month_pred|floatformat:2 }}</div>
                                {% with raw_change=next_month_pred|subtract:current_price %}
                                <div class="prediction-change {% if raw_change > 0 %}positive{% elif raw_change < 0 %}negative{% else %}neutral{% endif %}">
                                    {% if raw_change > 0 %}+{% endif %}${{ raw_change|floatformat:2 }} ({% if raw_change > 0 %}+{% endif %}{{ raw_change|multiply:100|divide:current_price|floatformat:2 }}%)
                                </div>
                                {% endwith %}
                            </div>
                            {% endif %}
                            {% endwith %}
                        </div>
                        {% endwith %} {# end with current_price #}
                    </div>
                {% endif %} {# end check if prediction exists #}
                {% endwith %} {# end with next_day_pred #}
                {% endwith %} {# end with model_type #}

                {# XGBOOST Section #}
                {% with model_type="xgboost" %}
                {% with next_day_pred=model_predictions.predictions.next_day|get_item:model_type %}
                {% if next_day_pred is not None %} {# Check if prediction exists for this model #}
                    <div class="prediction-model-section">
                        {# <h3 class="model-name">XGBOOST</h3> #}
                        {% with current_price=stock_info.currentPrice|default:stock_info.regularMarketPrice|default:stock_info.regularMarketPreviousClose|default:stock_historical_data.0.Close|default:206.37 %}
                        <div class="prediction-cards">
                             {# Next Day #}
                            <div class="prediction-card">
                                <div class="prediction-time">Next Day</div>
                                <div class="prediction-date">{{ model_predictions.prediction_dates.next_day }}</div>
                                <div class="prediction-price">${{ next_day_pred|floatformat:2 }}</div>
                                {% with raw_change=next_day_pred|subtract:current_price %}
                                <div class="prediction-change {% if raw_change > 0 %}positive{% elif raw_change < 0 %}negative{% else %}neutral{% endif %}">
                                    {% if raw_change > 0 %}+{% endif %}${{ raw_change|floatformat:2 }} ({% if raw_change > 0 %}+{% endif %}{{ raw_change|multiply:100|divide:current_price|floatformat:2 }}%)
                                </div>
                                {% endwith %}
                            </div>
                             {# Next Week #}
                            {% with next_week_pred=model_predictions.predictions.next_week|get_item:model_type %}
                            {% if next_week_pred is not None %}
                            <div class="prediction-card">
                                <div class="prediction-time">Next Week</div>
                                <div class="prediction-date">{{ model_predictions.prediction_dates.next_week }}</div>
                                <div class="prediction-price">${{ next_week_pred|floatformat:2 }}</div>
                                {% with raw_change=next_week_pred|subtract:current_price %}
                                <div class="prediction-change {% if raw_change > 0 %}positive{% elif raw_change < 0 %}negative{% else %}neutral{% endif %}">
                                    {% if raw_change > 0 %}+{% endif %}${{ raw_change|floatformat:2 }} ({% if raw_change > 0 %}+{% endif %}{{ raw_change|multiply:100|divide:current_price|floatformat:2 }}%)
                                </div>
                                {% endwith %}
                            </div>
                            {% endif %}
                            {% endwith %}
                             {# Next Month #}
                            {% with next_month_pred=model_predictions.predictions.next_month|get_item:model_type %}
                            {% if next_month_pred is not None %}
                            <div class="prediction-card">
                                <div class="prediction-time">Next Month</div>
                                <div class="prediction-date">{{ model_predictions.prediction_dates.next_month }}</div>
                                <div class="prediction-price">${{ next_month_pred|floatformat:2 }}</div>
                                {% with raw_change=next_month_pred|subtract:current_price %}
                                <div class="prediction-change {% if raw_change > 0 %}positive{% elif raw_change < 0 %}negative{% else %}neutral{% endif %}">
                                    {% if raw_change > 0 %}+{% endif %}${{ raw_change|floatformat:2 }} ({% if raw_change > 0 %}+{% endif %}{{ raw_change|multiply:100|divide:current_price|floatformat:2 }}%)
                                </div>
                                {% endwith %}
                            </div>
                            {% endif %}
                            {% endwith %}
                        </div>
                        {% endwith %} {# end with current_price #}
                    </div>
                {% endif %} {# end check if prediction exists #}
                {% endwith %} {# end with next_day_pred #}
                {% endwith %} {# end with model_type #}

            </div> {# End Second Row #}
        </div>

    </div>
    <hr style="margin: 30px 0;">
    {% endif %} {# End if model_predictions.models_available #}

    {# --- The rest of the template remains the same --- #}

    {# AI Analysis Section #}
    <h2>AI Stock Analysis</h2>
    <div class="ai-analysis-section">
        <div class="ai-buttons">
            <button id="analyze-groq-btn" class="btn btn-primary" data-analyzer="groq">
                <i class="fas fa-robot"></i> Analyze with Groq
            </button>
            <button id="analyze-local-btn" class="btn btn-secondary" data-analyzer="local">
                <i class="fas fa-desktop"></i> Analyze with Local LLM
            </button>
        </div>
        
        <div id="ai-analysis-result" style="display: none; margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; background-color: #f9f9f9;">
            <div id="ai-loading" style="text-align: center; display: none;">
                <i class="fas fa-spinner fa-spin"></i> Analyzing stock data...
            </div>
            <div id="ai-content">
                <h3 id="ai-overview-title">Overview</h3>
                <p id="ai-overview-text"></p>
                
                <h3>Pros</h3>
                <ul id="ai-pros-list"></ul>
                
                <h3>Cons</h3>
                <ul id="ai-cons-list"></ul>
                
                <h3>Verdict</h3>
                <p id="ai-verdict" class="verdict"></p>
                
                <p class="ai-source"><small id="ai-source-text">Analysis provided by Model</small></p>
            </div>
            <div id="ai-error" style="color: #d9534f; display: none;"></div>
        </div>
    </div>
    
    <hr style="margin: 30px 0;">

    {# Two-column layout for News and Sentiment Chart #}
    <div class="two-column-layout">
        {# Left Column: News Section #}
        <div class="column news-column">
            <h2>Recent News (Last 7 Days)</h2>
            <div class="action-buttons" style="margin-bottom: 15px;">
                <a href="{% url 'stock_news_with_symbol' symbol=stock_data.symbol %}" class="btn btn-news">
                    <i class="fas fa-newspaper"></i> View All News
                </a>
            </div>
            {% if news_items %}
                <div class="news-list" style="margin-bottom: 30px; max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px;">
                    {% for news in news_items %}
                        <div class="news-item" style="border: 1px solid #eee; padding: 15px; margin-bottom: 15px; border-radius: 5px; background-color: #fff;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                <h4 style="margin-top: 0; margin-bottom: 5px; flex: 1;">
                                    {{ news.headline }}
                                </h4>
                                <a href="{{ news.url }}" target="_blank" class="btn btn-visit-article" title="Read full article">
                                    <i class="fas fa-external-link-alt"></i> Visit
                                </a>
                            </div>
                            <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                                <strong>Source:</strong> {{ news.source }} |
                                <strong>Published:</strong>
                                {% timezone "Asia/Calcutta" %}
                                    {{ news.published_at|date:"Y-m-d H:i" }}
                                {% endtimezone %}
                                {% if news.sentiment_positive is not None %}
                                    | <strong>Sentiment:</strong>
                                    {% if news.sentiment_positive > news.sentiment_negative and news.sentiment_positive > news.sentiment_neutral %}
                                        <span style="color: green;">Positive</span> ({{ news.sentiment_positive|floatformat:2 }})
                                    {% elif news.sentiment_negative > news.sentiment_positive and news.sentiment_negative > news.sentiment_neutral %}
                                        <span style="color: red;">Negative</span> ({{ news.sentiment_negative|floatformat:2 }})
                                    {% else %}
                                        <span style="color: orange;">Neutral</span> ({{ news.sentiment_neutral|floatformat:2 }})
                                    {% endif %}
                                {% endif %}
                            </p>
                            {% if news.summary %}
                                <p style="font-size: 0.95em; margin-bottom: 0;">{{ news.summary|truncatewords:50 }}</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p>No recent news found for this stock.</p>
            {% endif %}
        </div>
        
        {# Right Column: Sentiment Pie Chart Section #}
        <div class="column sentiment-column">
            <h2>News Sentiment Distribution</h2>
            {% if total_analyzed_news > 0 %}
                <div class="sentiment-chart-container">
                    <canvas id="sentimentPieChart"></canvas>
                </div>
                <p style="text-align: center; font-size: 0.9em; color: #777;">Based on {{ total_analyzed_news }} analyzed news articles from the last 7 days.</p>
            {% else %}
                <p>No news articles with sentiment analysis found in the last 7 days.</p>
            {% endif %}
        </div>
    </div>

    <hr style="margin: 30px 0;">

    {# Historical Data Table - Moved below the chart and news/sentiment sections #}
    <h2>Historical Data Table</h2>
    {% if stock_historical_data %}
        <div class="data-table-container" style="max-height: 500px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
            <table style="width: 100%; border-collapse: collapse; text-align: center;">
                <thead style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1;">
                    <tr>
                        <th style="padding: 12px; border-bottom: 2px solid #dee2e6; font-weight: bold;">Date</th>
                        <th style="padding: 12px; border-bottom: 2px solid #dee2e6; font-weight: bold;">Open</th>
                        <th style="padding: 12px; border-bottom: 2px solid #dee2e6; font-weight: bold;">High</th>
                        <th style="padding: 12px; border-bottom: 2px solid #dee2e6; font-weight: bold;">Low</th>
                        <th style="padding: 12px; border-bottom: 2px solid #dee2e6; font-weight: bold;">Close</th>
                        <th style="padding: 12px; border-bottom: 2px solid #dee2e6; font-weight: bold;">Volume</th>
                    </tr>
                </thead>
                <tbody>
                    {% for data_point in stock_historical_data %}
                    <tr style="{% cycle 'background-color: #ffffff;' 'background-color: #f8f9fa;' %}">
                        <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">{% if data_point.Date %}{{ data_point.Date }}{% else %}N/A{% endif %}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">{{ data_point.Open|floatformat:2|default:"N/A" }}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">{{ data_point.High|floatformat:2|default:"N/A" }}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">{{ data_point.Low|floatformat:2|default:"N/A" }}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">{{ data_point.Close|floatformat:2|default:"N/A" }}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">{{ data_point.Volume|intcomma|default:"N/A" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>No historical data available for this stock.</p>
    {% endif %}

    <hr style="margin: 30px 0;">

    {# Display Prioritized Stock Info #}
    <h2>Key Information</h2>
    <dl class="stock-info-list">
        {% for key in important_keys %}
            {% if key not in excluded_keys %} {# Double check against excluded keys #}
                {% with value=stock_info|get_item:key %}
                    {% if value is not None and value != '' %}
                        <dt>{{ key|format_label }}</dt> {# Use format_label filter #}
                        {# Apply specific formatting based on key #}
                        {% if key == 'longBusinessSummary' %}
                            <dd>{{ value|format_summary|safe }}</dd>
                        {% elif key == 'companyOfficers' %}
                            {# Handled separately below #}
                        {% elif key == 'website' or key == 'Website' or key == 'url' or key == 'URL' or key == 'websiteUrl' %}
                            <dd>
                                {{ value|default:"N/A" }}
                                {% if value %}
                                    <a href="{{ value }}" target="_blank" class="btn btn-visit-website" title="Open website in new tab">
                                        <i class="fas fa-external-link-alt"></i> Visit
                                    </a>
                                {% endif %}
                            </dd>
                        {% elif key in epoch_keys %}
                            <dd>{{ value|format_epoch }}</dd>
                        {% elif key in large_number_keys %}
                            <dd>{{ value|intcomma|default:"N/A" }}</dd> {# Use intcomma for large numbers #}
                        {% elif key in percentage_keys %}
                             <dd>{{ value|format_percentage|default:"N/A" }}</dd>
                        {% elif key in currency_keys %}
                             <dd>{{ value|format_currency|default:"N/A" }}</dd>
                        {% else %}
                            <dd>{{ value|default:"N/A" }}</dd> {# Default for others #}
                             {% endif %} {# End of inner formatting if/elif/else #}
                    {% endif %} {# End of outer if value is not None #}
                {% endwith %}
            {% endif %}
        {% endfor %}
    </dl>

    <hr style="margin: 30px 0;">

    {# Display Company Officers Separately #}
    {% with officers=stock_info|get_item:'companyOfficers'|parse_officers %}
        {% if officers %}
            <h2>Company Officers</h2>
            <div class="stock-info-list"> {# Reuse styling #}
                <table>
                    <thead>
                        <tr><th>Name</th><th>Title</th><th>Age</th></tr>
                    </thead>
                    <tbody>
                    {% for officer in officers %}
                        <tr>
                            <td>{{ officer.name }}</td>
                            <td>{{ officer.title }}</td>
                            <td>{{ officer.age }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            <hr style="margin: 30px 0;">
        {% endif %}
    {% endwith %}

    {# Display Business Summary Separately #}
     {% with summary=stock_info|get_item:'longBusinessSummary' %}
        {% if summary %}
            <h2>Business Summary</h2>
            <div style="padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #fdfdfd; margin-top: 15px; line-height: 1.6;">
                 <p>{{ summary|format_summary|safe }}</p>
            </div>
            <hr style="margin: 30px 0;">
        {% endif %}
    {% endwith %}

    {# Collapsible Other Information Section #}
    <div id="other-info-container">
        <button type="button" id="toggle-other-info" class="btn btn-info" style="margin-bottom: 10px;">Show Other Information</button>
        <div id="other-info-content" style="display: none;"> {# Hidden by default #}
            <h2>Other Information</h2>
            <dl class="stock-info-list">
                {% for key, value in stock_info.items %}
                    {% if key not in important_keys and key not in excluded_keys and key != 'longBusinessSummary' and key != 'companyOfficers' %} {# Exclude already handled keys #}
                 {% if value is not None and value != '' %}
                    <dt>{{ key|format_label }}</dt> {# Use format_label filter #}
                     {# Apply specific formatting based on key - REPEAT FORMATTING LOGIC using context lists #}
                    {% if key in epoch_keys %}
                        <dd>{{ value|format_epoch }}</dd>
                    {% elif key in large_number_keys %}
                        <dd>{{ value|intcomma|default:"N/A" }}</dd>
                    {% elif key in percentage_keys %}
                         <dd>{{ value|format_percentage|default:"N/A" }}</dd>
                    {% elif key in currency_keys %}
                         <dd>{{ value|format_currency|default:"N/A" }}</dd>
                    {% else %}
                        <dd>{{ value|default:"N/A" }}</dd>
                         {% endif %} {# End of inner formatting if/elif/else #}
                 {% endif %} {# End of outer if value is not None #}
            {% endif %} {# End of outer if key not in ... #}
        {% endfor %}
            </dl>
        </div> {# End #other-info-content #}
    </div> {# End #other-info-container #}


    <p style="margin-top: 30px;"><a href="{% url 'home' %}" class="btn btn-secondary">Back to Search</a></p> {# Added button classes #}

    <style>
    .action-buttons {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        align-items: center;
    }

    .btn-update, .btn-watchlist, .btn-news, .btn-visit-website, .btn-visit-article {
        padding: 8px 15px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        text-decoration: none;
        font-size: 14px;
        font-weight: 600;
        display: flex;
        align-items: center;
        transition: all 0.2s;
    }

    .btn-update {
        background-color: rgba(52, 152, 219, 0.1);
        color: #3498db;
    }

    .btn-update:hover {
        background-color: rgba(52, 152, 219, 0.2);
        transform: translateY(-2px);
    }

    .btn-watchlist {
        background-color: rgba(255, 159, 67, 0.1);
        color: #ff9f43;
    }

    .btn-watchlist:hover {
        background-color: rgba(255, 159, 67, 0.2);
        transform: translateY(-2px);
    }

    .btn-news {
        background-color: rgba(0, 123, 255, 0.1);
        color: #007bff;
    }

    .btn-news:hover {
        background-color: rgba(0, 123, 255, 0.2);
        transform: translateY(-2px);
    }

    .btn-visit-website {
        background-color: rgba(46, 204, 113, 0.1);
        color: #2ecc71;
        margin-left: 10px;
        font-size: 13px;
        padding: 5px 10px;
    }

    .btn-visit-website:hover {
        background-color: rgba(46, 204, 113, 0.2);
        transform: translateY(-2px);
    }

    .btn-visit-article {
        background-color: rgba(41, 128, 185, 0.1);
        color: #2980b9;
        font-size: 13px;
        padding: 5px 10px;
        margin-left: 10px;
    }

    .btn-visit-article:hover {
        background-color: rgba(41, 128, 185, 0.2);
        transform: translateY(-2px);
    }

    .btn i {
        margin-right: 6px;
    }

    .last-updated-info {
        color: #777;
        font-size: 13px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
    }

    .last-updated-info i {
        margin-right: 5px;
    }
    /* Styles for the definition list */
    .stock-info-list dt {
        font-weight: bold;
        float: left;
        width: 200px; /* Adjust width as needed */
        clear: left;
        margin-bottom: 8px;
        padding-right: 10px; /* Space between term and definition */
    }

    .stock-info-list dd {
        margin-left: 210px; /* Should be slightly larger than dt width */
        margin-bottom: 8px;
        display: flex;
        align-items: center;
    }

    /* Style for the officers table */
    .stock-info-list table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    .stock-info-list th, .stock-info-list td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    .stock-info-list th {
        background-color: #f2f2f2;
    }

    /* Two-column layout for news and sentiment chart */
    .two-column-layout {
        display: flex;
        gap: 20px;
    }

    .two-column-layout .column {
        flex: 1;
    }

    .sentiment-chart-container {
        max-width: 400px;
        margin: 20px auto;
    }

    /* Prediction table styles */
    .predictions-panel {
        background-color: #f9f9f9;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
        border: 1px solid #e0e0e0;
    }

    .predictions-header {
        margin-bottom: 15px;
        color: #555;
    }

    .prediction-grid {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .prediction-row {
        display: flex;
        gap: 20px;
        flex-wrap: wrap; /* Allow wrapping on smaller screens */
    }

    .prediction-model-section {
        flex: 1;
        min-width: 300px; /* Minimum width before wrapping */
        margin-bottom: 20px; /* Add margin for wrapped items */
    }

    .model-name {
        font-size: 1.2em;
        margin-bottom: 10px;
    }

    .prediction-cards {
        display: flex;
        gap: 10px;
        flex-wrap: wrap; /* Allow cards to wrap */
    }

    .prediction-card {
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        flex: 1 1 100px; /* Allow shrinking, basis of 100px */
        min-width: 100px; /* Prevent cards from becoming too small */
        text-align: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 5px; /* Add spacing if cards wrap */
    }

    .prediction-time {
        font-weight: bold;
        margin-bottom: 5px;
    }

    .prediction-date {
        font-size: 0.9em;
        color: #777;
        margin-bottom: 10px;
    }

    .prediction-price {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .prediction-change {
        font-size: 0.9em;
        font-weight: bold;
    }

    .prediction-change.positive {
        color: green;
    }

    .prediction-change.negative {
        color: red;
    }

    .prediction-change.neutral {
        color: orange;
    }

    .model-description {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }

    .model-description dl {
        display: grid;
        grid-template-columns: 100px 1fr;
        gap: 10px;
    }

    .model-description dt {
        font-weight: bold;
        color: #444;
    }

    .model-description dd {
        margin-left: 0;
        color: #666;
    }

    /* Add responsive behavior for small screens */
    @media (max-width: 992px) { /* Adjust breakpoint if needed */
        .prediction-row {
           flex-direction: column;
        }
        .prediction-model-section {
             min-width: unset; /* Allow full width */
             width: 100%;
         }
    }
     @media (max-width: 480px) { /* Very small screens */
         .prediction-cards {
             flex-direction: column; /* Stack cards vertically */
             gap: 8px;
         }
         .prediction-card {
             flex-basis: auto; /* Reset basis */
             width: 100%; /* Make cards full width */
         }
     }

     /* AI Analysis Styles */
    .ai-analysis-section {
        padding: 20px;
        background-color: #f8f8f8;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-bottom: 30px;
    }

    .ai-buttons {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .ai-buttons .btn {
        padding: 10px 18px;
    }

    #ai-analysis-result {
        background-color: #fff;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 20px;
        margin-top: 20px;
    }

    #ai-loading i {
        font-size: 24px;
        margin-bottom: 10px;
    }

    #ai-content h3 {
        margin-top: 20px;
        margin-bottom: 10px;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
    }
    #ai-content h3:first-of-type {
        margin-top: 0;
    }

    #ai-pros-list, #ai-cons-list {
        list-style: none;
        padding-left: 0;
    }

    #ai-pros-list li::before {
        content: "\f058"; /* Font Awesome check-circle */
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        color: #28a745; /* Green */
        margin-right: 10px;
    }

    #ai-cons-list li::before {
        content: "\f057"; /* Font Awesome times-circle */
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        color: #dc3545; /* Red */
        margin-right: 10px;
    }

    #ai-pros-list li, #ai-cons-list li {
        margin-bottom: 8px;
        line-height: 1.5;
    }

    .verdict {
        font-weight: bold;
        font-size: 1.1em;
        padding: 10px;
        border-radius: 4px;
        text-align: center;
        margin-top: 10px;
    }

    .verdict.buy, .verdict.strong_buy {
        background-color: rgba(40, 167, 69, 0.1);
        color: #1e7e34;
        border: 1px solid rgba(40, 167, 69, 0.3);
    }

    .verdict.sell, .verdict.strong_sell {
        background-color: rgba(220, 53, 69, 0.1);
        color: #a71d2a;
        border: 1px solid rgba(220, 53, 69, 0.3);
    }

    .verdict.hold, .verdict.neutral {
        background-color: rgba(255, 193, 7, 0.1);
        color: #b98705;
        border: 1px solid rgba(255, 193, 7, 0.3);
    }

    .ai-source {
        text-align: right;
        margin-top: 15px;
        font-size: 0.85em;
        color: #888;
    }

    #ai-error {
        background-color: rgba(220, 53, 69, 0.1);
        color: #a71d2a;
        padding: 10px;
        border-radius: 4px;
        border: 1px solid rgba(220, 53, 69, 0.3);
    }
    </style>

    {# Chart.js Script & Other Scripts (Keep the JS part as it was) #}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // --- Chart Data (Full Dataset) ---
        const fullLabels = JSON.parse('{{ chart_labels|escapejs }}');
        const fullOpen = JSON.parse('{{ chart_open|escapejs }}');
        const fullHigh = JSON.parse('{{ chart_high|escapejs }}');
        const fullLow = JSON.parse('{{ chart_low|escapejs }}');
        const fullClose = JSON.parse('{{ chart_close|escapejs }}');
        const fullVolume = JSON.parse('{{ chart_volume|escapejs }}');

        // --- Commodity Data (Full Datasets) ---
        const commodityData = {};
        {% for name, data in commodity_chart_data.items %}
            commodityData['{{ name|escapejs }}'] = {
                labels: JSON.parse('{{ data.dates|escapejs }}'),
                close: JSON.parse('{{ data.close|escapejs }}')
            };
        {% endfor %}

        // Define colors for commodities
        const commodityColors = {
            'Gold': 'rgb(255, 215, 0)',    // Gold
            'Crude Oil': 'rgb(139, 69, 19)', // Brown
            'Bitcoin': 'rgb(247, 147, 26)'  // Orange
        };

        // --- Chart Initialization ---
        const ctx = document.getElementById('stockChart').getContext('2d');
        const stockChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [], // Initially empty, populated by filter function
                datasets: [
                    {
                        label: 'Close',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        yAxisID: 'y',
                        hidden: false
                    },
                    {
                        label: 'Open',
                        data: [],
                        borderColor: 'rgb(255, 159, 64)',
                        backgroundColor: 'rgba(255, 159, 64, 0.2)',
                        yAxisID: 'y',
                        hidden: true
                    },
                    {
                        label: 'High',
                        data: [],
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        yAxisID: 'y',
                        hidden: true
                    },
                    {
                        label: 'Low',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        yAxisID: 'y',
                        hidden: true
                    },
                    {
                        label: 'Volume',
                        data: [],
                        borderColor: 'rgb(153, 102, 255)',
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        type: 'bar',
                        yAxisID: 'y1',
                        hidden: true
                    }
                    // Commodity datasets will be added dynamically
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { title: { display: true, text: 'Date' } },
                    y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Price' } },
                    y1: { type: 'linear', display: false, position: 'right', title: { display: true, text: 'Volume' }, grid: { drawOnChartArea: false } } // Initially hidden
                },
                plugins: {
                    tooltip: { mode: 'index', intersect: false },
                    legend: { display: false }
                }
            }
        });

        // --- Data Filtering Function ---
        function filterChartData(period) {
            const endDate = new Date(); // Today
            let startDate;

            switch (period) {
                case '1m':
                    startDate = new Date(endDate);
                    startDate.setMonth(endDate.getMonth() - 1);
                    break;
                case '6m':
                    startDate = new Date(endDate);
                    startDate.setMonth(endDate.getMonth() - 6);
                    break;
                case '1y':
                    startDate = new Date(endDate);
                    startDate.setFullYear(endDate.getFullYear() - 1);
                    break;
                case '5y':
                    startDate = new Date(endDate);
                    startDate.setFullYear(endDate.getFullYear() - 5);
                    break;
                case 'max':
                default:
                    startDate = fullLabels.length > 0 ? new Date(fullLabels[0]) : new Date(); // Start from the earliest date available or today if no data
                    break;
            }

             // Handle cases where fullLabels might be empty
             if (fullLabels.length === 0) {
                 stockChart.data.labels = [];
                 stockChart.data.datasets.forEach(ds => ds.data = []);
                 stockChart.update();
                 return; // Exit if no historical data
             }


            const filteredLabels = [];
            const filteredOpen = [];
            const filteredHigh = [];
            const filteredLow = [];
            const filteredClose = [];
            const filteredVolume = [];

            for (let i = 0; i < fullLabels.length; i++) {
                const currentDate = new Date(fullLabels[i]);
                if (currentDate >= startDate) {
                    filteredLabels.push(fullLabels[i]);
                    filteredOpen.push(fullOpen[i]);
                    filteredHigh.push(fullHigh[i]);
                    filteredLow.push(fullLow[i]);
                    filteredClose.push(fullClose[i]);
                    filteredVolume.push(fullVolume[i]);
                }
            }

            // Update chart data
            stockChart.data.labels = filteredLabels;
            stockChart.data.datasets[0].data = filteredClose;
            stockChart.data.datasets[1].data = filteredOpen;
            stockChart.data.datasets[2].data = filteredHigh;
            stockChart.data.datasets[3].data = filteredLow;
            stockChart.data.datasets[4].data = filteredVolume;

            // Also update commodity datasets based on the new labels
            updateCommodityDatasets(filteredLabels);

            stockChart.update();
        }

        // --- Function to Update Commodity Datasets based on Stock Labels ---
        function updateCommodityDatasets(stockLabels) {
            Object.keys(commodityData).forEach(name => {
                const datasetIndex = stockChart.data.datasets.findIndex(ds => ds.label === name);
                if (datasetIndex !== -1) { // Only update if dataset exists (i.e., checkbox is checked)
                    const commData = commodityData[name];
                    const alignedClose = [];

                    // Create a map for quick lookup of commodity prices by date
                    const commPriceMap = new Map();
                    // Handle empty commodity data
                    if (commData && commData.labels && commData.labels.length > 0) {
                        for (let i = 0; i < commData.labels.length; i++) {
                             commPriceMap.set(commData.labels[i], commData.close[i]);
                         }
                     }

                    // Align commodity data with stock labels
                    stockLabels.forEach(label => {
                        // Replace ?? with ternary operator for broader compatibility
                        alignedClose.push(commPriceMap.has(label) ? commPriceMap.get(label) : null);
                    });

                    stockChart.data.datasets[datasetIndex].data = alignedClose;
                }
            });
            // Don't call stockChart.update() here, it's called in filterChartData
        }


        // --- Event Listeners ---

        // Duration buttons
        document.querySelectorAll('.duration-selector button').forEach(button => {
            button.addEventListener('click', function() {
                // Update active class
                document.querySelectorAll('.duration-selector button').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                // Filter data
                filterChartData(this.getAttribute('data-period'));
            });
        });

        // Series toggle checkboxes
        document.querySelectorAll('.chart-toggle').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const datasetIndex = parseInt(this.getAttribute('data-dataset-index'));
                const isVisible = this.checked;
                stockChart.setDatasetVisibility(datasetIndex, isVisible);

                // Special handling for volume axis visibility
                if (datasetIndex === 4) { // Index of Volume dataset
                    stockChart.options.scales.y1.display = isVisible;
                }
                stockChart.update();
            });
            // Initial sync for volume axis
            if (parseInt(checkbox.getAttribute('data-dataset-index')) === 4) {
                stockChart.options.scales.y1.display = checkbox.checked;
            }
        });

        // Commodity toggle checkboxes
        document.querySelectorAll('.commodity-toggle').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const commodityName = this.getAttribute('data-commodity');
                const isVisible = this.checked;
                const existingDatasetIndex = stockChart.data.datasets.findIndex(ds => ds.label === commodityName);

                if (isVisible && existingDatasetIndex === -1) {
                    // Add dataset if it doesn't exist
                    if (commodityData[commodityName]) {
                        const commData = commodityData[commodityName];
                        const alignedClose = [];
                        const currentLabels = stockChart.data.labels; // Use currently displayed labels

                        // Align data
                        const commPriceMap = new Map();
                         if (commData && commData.labels && commData.labels.length > 0) {
                             for (let i = 0; i < commData.labels.length; i++) {
                                 commPriceMap.set(commData.labels[i], commData.close[i]);
                             }
                         }
                        currentLabels.forEach(label => {
                            // Replace ?? with ternary operator for broader compatibility
                            alignedClose.push(commPriceMap.has(label) ? commPriceMap.get(label) : (null));
                        });

                        const newDataset = {
                            label: commodityName,
                            data: alignedClose,
                            borderColor: commodityColors[commodityName] || 'rgb(100, 100, 100)', // Default color
                            backgroundColor: (commodityColors[commodityName] || 'rgb(100, 100, 100)').replace('rgb', 'rgba').replace(')', ', 0.1)'), // Lighter fill
                            yAxisID: 'y', // Plot on the main price axis
                            hidden: false,
                            borderDash: [5, 5], // Dashed line for commodities
                            pointRadius: 1, // Smaller points
                            tension: 0.1
                        };
                        stockChart.data.datasets.push(newDataset);
                    }
                } else if (!isVisible && existingDatasetIndex !== -1) {
                    // Remove dataset if it exists
                    stockChart.data.datasets.splice(existingDatasetIndex, 1);
                }
                stockChart.update();
            });
        });

        // --- Initial Chart Load ---
        filterChartData('1m'); // Load 1 Month data by default
        // Ensure initial visibility matches checkboxes
        document.querySelectorAll('.chart-toggle').forEach(checkbox => {
             const datasetIndex = parseInt(checkbox.getAttribute('data-dataset-index'));
             stockChart.setDatasetVisibility(datasetIndex, checkbox.checked);
             if (datasetIndex === 4) {
                 stockChart.options.scales.y1.display = checkbox.checked;
             }
        });
         stockChart.update(); // Final update on load


        // --- Collapsible Section Script ---
        const toggleBtn = document.getElementById('toggle-other-info');
        const otherInfoContent = document.getElementById('other-info-content');

        if (toggleBtn && otherInfoContent) {
            toggleBtn.addEventListener('click', function() {
                const isHidden = otherInfoContent.style.display === 'none';
                otherInfoContent.style.display = isHidden ? 'block' : 'none';
                this.textContent = isHidden ? 'Hide Other Information' : 'Show Other Information';
            });
        }

        // --- Sentiment Pie Chart ---
        // Ensure sentiment data is available before parsing
        const sentimentRaw = '{{ sentiment_percentages|escapejs|default:"{}" }}';
        let sentimentData = {};
        try {
            sentimentData = JSON.parse(sentimentRaw);
        } catch (e) {
            console.error("Could not parse sentiment data:", sentimentRaw, e);
            sentimentData = {}; // Default to empty object on error
        }

        const sentimentLabels = ['Positive', 'Neutral', 'Negative']; // Order matters for colors
        const sentimentValues = [
            sentimentData.positive || 0,
            sentimentData.neutral || 0,
            sentimentData.negative || 0
        ];

        // Check if there's data to display
        const hasSentimentData = sentimentValues.some(v => v > 0);
        const pieChartCanvas = document.getElementById('sentimentPieChart');

        if (hasSentimentData && pieChartCanvas) {
            const pieCtx = pieChartCanvas.getContext('2d');
            const sentimentPieChart = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: sentimentLabels,
                    datasets: [{
                        label: 'Sentiment Distribution (%)',
                        data: sentimentValues,
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.7)', // Positive (Greenish)
                            'rgba(255, 206, 86, 0.7)', // Neutral (Yellowish)
                            'rgba(255, 99, 132, 0.7)'  // Negative (Reddish)
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed.toFixed(1) + '%'; // Show percentage
                                    }
                                    return label;
                                }
                            }
                        },
                        title: {
                            display: false, // Title is already above the chart
                            text: 'News Sentiment Distribution (%)'
                        }
                    }
                }
            });
        } else if (pieChartCanvas) {
             console.log("No sentiment data to display or canvas not found.");
             // Optionally hide the canvas or display a message
             // pieChartCanvas.style.display = 'none';
             // document.querySelector('.sentiment-column p').textContent = 'Sentiment data unavailable.';
        }


        // --- AI Analysis functionality ---
        document.addEventListener('DOMContentLoaded', function() {
            const groqBtn = document.getElementById('analyze-groq-btn'); // Use updated ID
            const localBtn = document.getElementById('analyze-local-btn');
            const resultDiv = document.getElementById('ai-analysis-result');
            const loadingDiv = document.getElementById('ai-loading');
            const contentDiv = document.getElementById('ai-content');
            const errorDiv = document.getElementById('ai-error');

            // Parse key metrics safely
            let keyMetricsData = {};
            try {
                keyMetricsData = JSON.parse('{{ key_metrics_json|escapejs|default:"{}" }}');
            } catch(e) {
                console.error("Failed to parse key metrics JSON:", e);
            }


            // Function to safely get prediction value
            function getPredictionValue(period, model) {
                 try {
                     const pred = {{ model_predictions.predictions|default:'{}'|escapejs }}[period][model];
                     // Check if pred is a valid number, return 0 otherwise
                     return (typeof pred === 'number' && !isNaN(pred)) ? pred : 0;
                 } catch (e) {
                     return 0; // Return 0 if path doesn't exist or value is invalid
                 }
            }

            // Function to safely get prediction date
            function getPredictionDate(period) {
                 try {
                     return {{ model_predictions.prediction_dates|default:'{}'|escapejs }}[period] || '';
                 } catch (e) {
                     return '';
                 }
            }

            // Function to handle AI analysis
            async function analyzeStock(analyzer) {
                // Show loading state
                resultDiv.style.display = 'block';
                loadingDiv.style.display = 'block';
                contentDiv.style.display = 'none';
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';

                try {
                    // Gather relevant data from UI elements
                    const collectedData = {
                        symbol: '{{ stock_data.symbol|escapejs }}',
                        name: '{{ stock_data.name|default:stock_data.symbol|escapejs }}',
                        analyzer: analyzer,

                        // Current price and key metrics
                        currentPrice: parseFloat('{{ stock_info.currentPrice|default:stock_info.regularMarketPrice|default:stock_info.regularMarketPreviousClose|default:stock_historical_data.0.Close|default:"0"|escapejs }}') || 0,
                        keyMetrics: {},

                        // Prediction data
                        predictions: {},

                        // Sentiment data (using parsed data from above)
                        sentiment: {
                            positive: sentimentValues[0], // From sentiment pie chart calculation
                            neutral: sentimentValues[1],
                            negative: sentimentValues[2]
                        },

                        // News headlines
                        newsHeadlines: []
                    };

                    // Collect key metrics from the parsed keyMetricsData object
                    Object.keys(keyMetricsData).forEach(key => {
                        const value = keyMetricsData[key]; // Get value directly from JS object
                        if (value !== null && value !== undefined && value !== '') { // Check if value exists and is not empty string
                            // Try to parse as float, otherwise keep as string
                            const numValue = parseFloat(value);
                            collectedData.keyMetrics[key] = isNaN(numValue) ? value : numValue;
                         }
                    });

                    // Collect prediction data from prediction cards safely
                    {% for model_type in model_predictions.model_types|default_if_none:'' %}
                        {% if model_type %} {# Ensure model_type is not empty #}
                            collectedData.predictions['{{ model_type|escapejs }}'] = {
                                next_day: getPredictionValue('next_day', '{{ model_type|escapejs }}'),
                                next_week: getPredictionValue('next_week', '{{ model_type|escapejs }}'),
                                next_month: getPredictionValue('next_month', '{{ model_type|escapejs }}'),
                                dates: {
                                    next_day: getPredictionDate('next_day'),
                                    next_week: getPredictionDate('next_week'),
                                    next_month: getPredictionDate('next_month')
                                }
                            };
                        {% endif %}
                    {% empty %}
                         console.log("No model types found for predictions.");
                    {% endfor %}

                    // Collect news headlines safely
                    {% for news in news_items|default_if_none:'' %}
                     {% if news %} {# Ensure news item is not empty #}
                    collectedData.newsHeadlines.push({
                        headline: '{{ news.headline|escapejs|default:"" }}',
                        source: '{{ news.source|escapejs|default:"" }}',
                        published_at: '{{ news.published_at|date:"Y-m-d H:i"|default:"" }}',
                        sentiment: {
                            positive: parseFloat('{{ news.sentiment_positive|default:"0" }}'),
                            neutral: parseFloat('{{ news.sentiment_neutral|default:"0" }}'),
                            negative: parseFloat('{{ news.sentiment_negative|default:"0" }}')
                        }
                    });
                     {% endif %}
                    {% empty %}
                         console.log("No news items found.");
                    {% endfor %}

                    // Make API request with collected data
                    const response = await fetch('{% url 'ajax_get_ai_analysis' symbol=stock_data.symbol %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(collectedData) // Send the structured data
                    });

                     if (!response.ok) {
                         // Handle HTTP errors (like 500, 404)
                         throw new Error(`HTTP error! Status: ${response.status} - ${response.statusText}`);
                     }

                    const data = await response.json();

                    // Hide loading state
                    loadingDiv.style.display = 'none';

                    if (data.error) {
                        // Show error
                        errorDiv.style.display = 'block';
                        errorDiv.textContent = data.error;
                        contentDiv.style.display = 'none'; // Hide content on error
                    } else if (data.overview && data.pros && data.cons && data.verdict) {
                         // Check if essential data fields exist before displaying
                        contentDiv.style.display = 'block';
                        errorDiv.style.display = 'none'; // Hide error div

                        // Populate UI elements with analysis data
                        document.getElementById('ai-overview-text').textContent = data.overview || 'No overview provided.';

                        // Populate pros list
                        const prosList = document.getElementById('ai-pros-list');
                        prosList.innerHTML = ''; // Clear previous items
                        if (data.pros && data.pros.length > 0) {
                             data.pros.forEach(pro => {
                                const li = document.createElement('li');
                                li.textContent = pro;
                                prosList.appendChild(li);
                            });
                        } else {
                             prosList.innerHTML = '<li>No specific pros identified.</li>';
                         }

                        // Populate cons list
                        const consList = document.getElementById('ai-cons-list');
                        consList.innerHTML = ''; // Clear previous items
                         if (data.cons && data.cons.length > 0) {
                             data.cons.forEach(con => {
                                const li = document.createElement('li');
                                li.textContent = con;
                                consList.appendChild(li);
                            });
                         } else {
                             consList.innerHTML = '<li>No specific cons identified.</li>';
                         }

                        // Set verdict
                        const verdictElement = document.getElementById('ai-verdict');
                         const verdictText = data.verdict ? data.verdict.toUpperCase().replace('_', ' ') : 'UNKNOWN';
                         const verdictClass = data.verdict ? data.verdict.toLowerCase() : 'neutral';
                         verdictElement.textContent = verdictText;
                         // Remove old classes and add new ones
                         verdictElement.className = 'verdict ' + verdictClass;

                        // Set source information
                        let sourceText = 'Analysis provided by Unknown';
                         if (data.analyzer_used === 'groq') { sourceText = 'Analysis provided by Groq'; }
                         else if (data.analyzer_used === 'local') { sourceText = 'Analysis provided by Local LLM'; }
                         else if (data.analyzer_used === 'gemini') { sourceText = 'Analysis provided by Google Gemini AI'; } // Added Gemini check
                        document.getElementById('ai-source-text').textContent = sourceText;
                     } else {
                         // Handle case where response is successful but data is incomplete
                         errorDiv.style.display = 'block';
                         errorDiv.textContent = 'Received incomplete analysis data from the server.';
                         contentDiv.style.display = 'none';
                     }

                } catch (error) {
                    // Handle fetch errors or JSON parsing errors
                    loadingDiv.style.display = 'none';
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = `Analysis Request Failed: ${error.message}. Please check the console for details.`;
                    contentDiv.style.display = 'none'; // Hide content on error
                    console.error('AI analysis error:', error);
                }
            }

            // Add event listeners to buttons only if they exist
            if (groqBtn) {
                groqBtn.addEventListener('click', () => analyzeStock('groq')); // Use 'groq'
            } else {
                console.warn("Groq analyze button not found.");
            }

            if (localBtn) {
                localBtn.addEventListener('click', () => analyzeStock('local'));
            } else {
                 console.warn("Local LLM analyze button not found.");
             }
        });

    </script>
{% endblock %}